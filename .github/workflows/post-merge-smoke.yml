name: Post-Merge Smoke

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  smoke:
    name: Check deployed endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      PROD_WEB_URL: ${{ vars.PROD_WEB_URL }}
      PROD_SERVER_URL: ${{ vars.PROD_SERVER_URL }}

    steps:
      - name: Detect smoke-check config
        id: config
        run: |
          if [ -z "$PROD_WEB_URL" ] || [ -z "$PROD_SERVER_URL" ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "Smoke checks skipped (set PROD_WEB_URL and PROD_SERVER_URL to enable)."
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Check frontend responds
        if: steps.config.outputs.enabled == 'true'
        run: |
          curl --fail --show-error --silent --location "$PROD_WEB_URL" > /dev/null

      - name: Check backend health endpoint
        if: steps.config.outputs.enabled == 'true'
        run: |
          curl --fail --show-error --silent --location "$PROD_SERVER_URL/healthz" > /dev/null
